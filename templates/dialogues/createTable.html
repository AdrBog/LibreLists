<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/dialogue.css">
    <link rel="stylesheet" href="/static/css/pops.css">
    <link rel="shortcut icon" href="/static/favicon.ico">
</head>
<body>
    <div>
        <label>Table name:</label><br>
        <input type="text" id="table-name">
    </div>
    <hr>
    Columns:
    <div id="column-list"></div>
    <button onclick="addColumnField()">+</button>
    <br>
    <hr>
    <br>
    <button class="primary" onclick="createTable()">Create table</button>
    <script src="/static/js/global.js"></script>
    <script src="/static/js/pops.js"></script>
    <script>
        const POP = new Pops();
        const columnList = document.getElementById("column-list");
        var tableInfo = {};

        columnList.addEventListener("click", (e) => {
            if (e.target.getAttribute("delete"))
                e.target.parentElement.remove();
        })

        function addColumnField(name = "", type = "TEXT", constraint = "", _null = "", _delete = true){
            const options = {
                "tableType":{
                    "TEXT": "TEXT",
                    "NUMERIC": "NUMERIC",
                    "INTEGER": "INTEGER",
                    "REAL": "REAL",
                    "DATE": "DATE"
                },
                "tableConstraint":{
                    "": "",
                    "PRIMARY KEY": "PRIMARY KEY",
                    "UNIQUE": "UNIQUE"
                },
                "tableNull": {
                    "": "",
                    "NOT NULL": "NOT NULL",
                    "AUTOINCREMENT": "AUTOINCREMENT"
                }
            };
            const datalist = ["CURRENT_TIMESTAMP"];
            const div = document.createElement("div");
            const tableName = document.createElement("input");
            const tableType = document.createElement("select");
            const tableConstraint = document.createElement("select");
            const tableNull = document.createElement("select");
            const tableDefault = document.createElement("input");
            const tableDefaultList = document.createElement("datalist");
            const deleteButton = document.createElement("button");

            div.classList.add("item");
            tableName.placeholder = "NAME";
            tableName.value = name;
            tableDefault.placeholder = "EXTRA (E.G. DEFAULT, CHECK)";
            tableDefault.setAttribute("list", "default-options");
            tableDefaultList.id = "default-options";
            for (const key of datalist) {
                const option = document.createElement("option");
                option.value = key;
                tableDefaultList.append(option);
            }

            for (const key in options) {
                for (const opt in options[key]) {
                    const option = document.createElement("option");
                    option.value = options[key][opt];

                    if (key == "tableType" && options[key][opt] == type)
                        option.selected = true;
                    if (key == "tableConstraint" && options[key][opt] == constraint)
                        option.selected = true;
                    if (key == "tableNull" && options[key][opt] == _null)
                        option.selected = true;

                    option.innerText = opt;
                    eval(`${key}.append(option)`);
                }
            }

            deleteButton.innerText = "X";
            deleteButton.setAttribute("delete", true);

            div.append(tableName, tableType, tableConstraint, tableNull, tableDefault, tableDefaultList);
            if (_delete)
                div.append(deleteButton);
            columnList.append(div);
        }

        async function createTable(){
            tableInfo["name"] = document.getElementById("table-name").value;
            tableInfo["columns"] = {};
            tableInfo["table_config"] = {};
            for (const key of columnList.querySelectorAll("div")) {
                const column = key.querySelectorAll("input")[0].value;
                tableInfo["columns"][column] = {}
                tableInfo["columns"][column]["type"] = key.querySelectorAll("select")[0].value;
                tableInfo["columns"][column]["constraint"] = key.querySelectorAll("select")[1].value;
                tableInfo["columns"][column]["null"] = key.querySelectorAll("select")[2].value;
                tableInfo["columns"][column]["default"] = key.querySelectorAll("input")[1].value;
            }

            const res = await fetch("/create/table/{{ id }}", {
                method: "POST",
                body: JSON.stringify({
                    "table_info": tableInfo,
                }),
                headers: {"Content-type": "application/json; charset=UTF-8"}
            });
            const data = await res.json();
            if (data["response"] == "Error")
                await POP.alert("Error:\n" + data["why"]);
            else
                await POP.alert("Table created");
            
            try{
                parent.refreshTableList();
            }catch{}
        }

        addColumnField("ID", "INTEGER", "PRIMARY KEY", "AUTOINCREMENT", false);

    </script>
</body>
</html>